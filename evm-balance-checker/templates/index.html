<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain Portfolio Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root[data-theme="light"] {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e0e0e0;
            --hover-bg: #f8f9fa;
            --button-hover: #e8e9ea;
            --shadow: rgba(0,0,0,0.1);
            --shadow-hover: rgba(0,0,0,0.15);
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
        }

        :root[data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #0f3460;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border-color: #1e3a5f;
            --hover-bg: #1a4d7a;
            --button-hover: #2a5d8a;
            --shadow: rgba(0,0,0,0.3);
            --shadow-hover: rgba(0,0,0,0.5);
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 13px;
            }
        }

        .mono {
            font-family: 'JetBrains Mono', 'Monaco', 'Courier New', monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 8px;
        }

        @media (min-width: 769px) {
            .container {
                padding: 0 20px;
            }
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
            position: relative;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-weight: 700;
        }

        @media (min-width: 769px) {
            .header {
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 15px;
            }
        }

        .header-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin: 0 auto 20px;
            width: fit-content;
        }

        @media (max-width: 768px) {
            .header {
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 12px;
            }
            
            .header-controls {
                padding: 6px 10px;
                gap: 8px;
            }
        }

        .refresh-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 20px;
            font-weight: bold;
        }

        .refresh-icon:hover {
            background: var(--hover-bg);
            color: var(--accent-primary);
            transform: rotate(180deg);
        }

        .refresh-icon.spinning {
            color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .refresh-icon:disabled svg {
            animation: none;
        }

        .controls-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
        }

        /* Loading indicator for chains */
        .chain-loading {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75em;
            color: var(--text-tertiary);
            margin-left: 8px;
        }

        .chain-loading-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--hover-bg);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Toggle Switch */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .3s;
            border-radius: 26px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        :root[data-theme="dark"] .slider {
            background-color: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
        }

        :root[data-theme="light"] .slider {
            background-color: rgba(0,0,0,0.15);
            border: 1px solid rgba(0,0,0,0.3);
        }

        .slider:before {
            position: absolute;
            content: "üåô";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        input:checked + .slider {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.3);
        }

        :root[data-theme="dark"] input:checked + .slider {
            background-color: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
            content: "‚òÄÔ∏è";
        }

        .slider:hover {
            background-color: rgba(255,255,255,0.4);
        }

        .search-box {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px var(--shadow);
            margin-bottom: 25px;
            transition: background 0.3s ease;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .saved-addresses {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .saved-address {
            padding: 8px 14px;
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--text-primary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .saved-address:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .saved-address .remove {
            color: #dc3545;
            font-weight: bold;
            margin-left: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.1em;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
        }

        @media (min-width: 769px) {
            .card {
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 5px 15px var(--shadow);
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--text-primary);
            font-size: 1.4em;
            font-weight: 700;
        }

        .cache-info {
            font-size: 0.8em;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cache-info.cached {
            color: #28a745;
        }

        .cache-info.stale {
            color: #ffc107;
        }

        .total-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .summary-label {
            color: var(--text-secondary);
            font-size: 0.75em;
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (min-width: 769px) {
            .summary-label {
                font-size: 0.9em;
                margin-bottom: 8px;
            }
        }

        .summary-value {
            font-size: 1.6em;
            font-weight: 700;
            color: #667eea;
        }

        @media (min-width: 769px) {
            .summary-value {
                font-size: 2.2em;
            }
        }

        .chain-filters {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--hover-bg);
            border-radius: 8px;
        }

        @media (min-width: 769px) {
            .chain-filters {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-bottom: 20px;
                padding: 15px;
                border-radius: 10px;
            }
        }

        .chain-filter {
            padding: 6px 10px;
            border-radius: 16px;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        @media (min-width: 769px) {
            .chain-filter {
                padding: 8px 18px;
                border-radius: 20px;
                font-size: 0.9em;
                gap: 6px;
            }

            .chain-filter:hover {
                border-color: #667eea;
                transform: translateY(-2px);
            }
        }

        .chain-filter img {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        @media (min-width: 769px) {
            .chain-filter img {
                width: 20px;
                height: 20px;
            }
        }

        .chain-filter.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .wide-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            transition: all 0.2s;
            box-shadow: 0 2px 6px var(--shadow);
            font-size: 0.9em;
        }

        @media (min-width: 769px) {
            .wide-card {
                border-radius: 12px;
                padding: 16px 20px;
                margin-bottom: 12px;
                border-left: 4px solid #667eea;
                grid-template-columns: auto 1fr auto auto;
                gap: 20px;
                font-size: 1em;
            }

            .wide-card:hover {
                transform: translateX(4px);
                box-shadow: 0 4px 12px var(--shadow-hover);
            }
        }

        /* Stack amount and value on mobile */
        @media (max-width: 768px) {
            .token-amount {
                grid-column: 2;
                text-align: left;
            }

            .usd-value {
                grid-column: 2;
                text-align: left;
                margin-top: -5px;
            }
        }

        .token-icon-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .token-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        .token-icon img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .token-icon .token-fallback {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .token-info {
            flex: 1;
        }

        .token-symbol {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .token-chain {
            font-size: 0.85em;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .token-chain {
                font-size: 0.5em;
            }
        }

        .token-amount {
            text-align: right;
            min-width: 100px;
        }

        @media (min-width: 769px) {
            .token-amount {
                min-width: 180px;
            }
        }

        .amount-value {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        @media (min-width: 769px) {
            .amount-value {
                font-size: 1.15em;
                margin-bottom: 3px;
            }
        }

        .amount-label {
            font-size: 0.8em;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .usd-value {
            text-align: right;
            min-width: 100px;
        }

        @media (min-width: 769px) {
            .usd-value {
                min-width: 150px;
            }
        }

        .usd-amount {
            font-size: 1em;
            font-weight: 700;
            color: #28a745;
        }

        @media (min-width: 769px) {
            .usd-amount {
                font-size: 1.2em;
            }
        }

        .defi-card {
            border-left-color: #764ba2;
        }

        .protocol-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%);
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: #667eea;
            margin-left: 8px;
        }

        .supply-badge {
            background: linear-gradient(135deg, rgba(67, 233, 123, 0.25) 0%, rgba(56, 189, 248, 0.25) 100%);
            color: #43e97b;
        }

        .borrow-badge {
            background: linear-gradient(135deg, rgba(250, 112, 154, 0.25) 0%, rgba(254, 225, 64, 0.25) 100%);
            color: #fa709a;
        }

        .health-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .health-good {
            background: rgba(67, 233, 123, 0.25);
            color: #43e97b;
        }

        .health-warning {
            background: rgba(254, 225, 64, 0.25);
            color: #fee140;
        }

        .health-critical {
            background: rgba(250, 112, 154, 0.25);
            color: #fa709a;
        }

        .aave-group {
            border-left-width: 3px;
            border-left-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        @media (min-width: 769px) {
            .aave-group {
                border-left-width: 4px;
            }
        }

        .aave-detail {
            margin-left: 8px;
            border-left-width: 2px;
            opacity: 0.9;
            font-size: 0.95em;
        }

        @media (min-width: 769px) {
            .aave-detail {
                margin-left: 20px;
                font-size: 1em;
            }
        }

        .aave-summary {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        @media (max-width: 768px) {
            .aave-summary {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
        }

        .aave-line {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .aave-line {
                font-size: 0.8em;
            }
        }

        .negative {
            color: #fa709a !important;
        }

        .position-type {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-hover);
            border-left: 4px solid #fa709a;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.show {
            display: flex;
        }

        .toast-icon {
            font-size: 1.5em;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .toast-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: var(--hover-bg);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .scroll-to-top:active {
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .scroll-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }

        /* Footer */
        .footer {
            text-align: center;
            color: white;
            padding: 30px 20px;
            margin-top: 40px;
            font-size: 0.9em;
        }

        .footer-links {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .footer a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .footer {
                padding: 20px 10px;
                margin-top: 30px;
                font-size: 0.85em;
            }
        }

        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        @media (max-width: 768px) {
            .scroll-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }

        /* Clickable Summary Cards */
        .clickable-summary {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-summary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-hover);
        }

        .clickable-summary:active {
            transform: translateY(0);
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .error.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .stats-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--hover-bg);
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Charts Section */
        .charts-section {
            margin-top: 30px;
            margin-bottom: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            max-width: 100%;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 20px;
                margin-bottom: 20px;
            }
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            margin-bottom: 12px;
            max-width: 100%;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
            min-width: 0;
        }

        .chart-card > * {
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .chart-card .chart-header {
            max-width: 100%;
            overflow: visible;
        }

        .chart-card .chart-container {
            max-width: 100%;
            overflow: hidden;
        }

        .chart-card canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        @media (max-width: 768px) {
            .chart-card {
                padding: 8px;
            }

            .chart-card canvas {
                max-height: 200px !important;
            }
        }

        @media (min-width: 769px) {
            .chart-card {
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 20px;
            }

            .chart-card:hover {
                box-shadow: var(--shadow-hover);
            }
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 100%;
            overflow: hidden;
        }

        @media (min-width: 1024px) {
            .charts-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        /* Constrain chart legend to prevent overflow */
        .chart-card ul {
            max-width: 100% !important;
            overflow: hidden !important;
            word-wrap: break-word !important;
        }

        .chart-card li {
            max-width: 100% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        @media (max-width: 768px) {
            .chart-card li {
                font-size: 9px !important;
                max-width: 100% !important;
            }
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            max-width: 100%;
            overflow: visible;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .chart-header {
                flex-direction: column-reverse;
                gap: 10px;
                margin-bottom: 15px;
                align-items: center;
            }
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .chart-title {
                font-size: 1em;
                width: 100%;
                text-align: center;
            }
        }

        .chart-toggle {
            display: flex;
            gap: 5px;
            background: var(--hover-bg);
            border-radius: 8px;
            padding: 4px;
        }

        @media (max-width: 768px) {
            .chart-toggle {
                width: auto;
                justify-content: center;
            }
        }

        .chart-toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .chart-toggle-btn.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .chart-toggle-btn:hover:not(.active) {
            background: var(--button-hover);
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
            max-width: 100%;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: auto;
                min-height: 200px;
                max-height: 250px;
            }
        }

        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }

        .chain-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--hover-bg);
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .chain-icon-img {
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }

        @media (max-width: 1024px) {
            .theme-toggle {
                position: static;
                margin: 10px auto;
                display: block;
            }
        }

        @media (max-width: 768px) {
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .input-group {
                flex-direction: column;
            }

            .wide-card {
                padding: 12px 15px;
                gap: 12px;
                margin-bottom: 10px;
            }

            .aave-detail {
                margin-left: 10px;
            }

            .aave-summary {
                font-size: 0.85em;
            }

            .protocol-badge, .health-badge {
                font-size: 0.7em;
                padding: 3px 8px;
                margin-left: 4px;
            }

            .token-icon img {
                width: 32px;
                height: 32px;
            }

            .token-fallback {
                width: 32px;
                height: 32px;
                font-size: 9px;
            }

            .amount-value, .usd-amount {
                font-size: 0.95em;
            }

            .amount-label {
                font-size: 0.75em;
            }

            .chart-card {
                padding: 15px;
            }

            .stats-bar {
                flex-direction: column;
                gap: 10px;
            }

            .stat-item {
                min-width: auto;
                width: 100%;
            }

            .summary-value {
                font-size: 1.6em;
            }
        }

        @media (max-width: 480px) {
            .wide-card {
                padding: 10px 12px;
                gap: 10px;
            }

            .token-symbol {
                font-size: 0.9em;
            }

            .position-type {
                font-size: 0.75em;
            }

            .summary-value {
                font-size: 1.4em;
            }
        }

        /* Smooth transitions for theme switching */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <button class="refresh-icon" id="refreshIcon" onclick="handleRefreshClick()" title="Tap to refresh ‚Ä¢ Double-tap to clear cache" style="display:none;">
                    ‚Üª
                </button>
                <div class="controls-divider" id="controlsDivider" style="display:none;"></div>
                <label class="theme-switch" title="Toggle theme">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
            <h1>üåê Multi-Chain Portfolio Tracker</h1>
        </div>

        <div class="search-box">
            <div class="input-group">
                <input 
                    type="text" 
                    id="addressInput" 
                    placeholder="Enter address or ENS name (e.g., vitalik.eth)"
                    value=""
                >
                <button id="checkButton" onclick="checkAddress()">Check Address</button>
            </div>
            <div id="savedAddresses" class="saved-addresses"></div>
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingMessage">Resolving address...</p>
        </div>

        <div class="results" id="results">
            <div class="card">
                <div class="card-header">
                    <h2>üí∞ Portfolio Summary</h2>
                    <div class="cache-info" id="cacheInfo"></div>
                </div>
                <div class="total-summary">
                    <div class="summary-card">
                        <div class="summary-label">Total Value</div>
                        <div class="summary-value mono" id="totalValue">$0</div>
                    </div>
                    <div class="summary-card clickable-summary" onclick="scrollToWallet()">
                        <div class="summary-label">Wallet Tokens</div>
                        <div class="summary-value mono" id="walletValue">$0</div>
                    </div>
                    <div class="summary-card clickable-summary" onclick="scrollToDefi()">
                        <div class="summary-label">DeFi Positions</div>
                        <div class="summary-value mono" id="defiValue">$0</div>
                    </div>
                </div>
                <div class="stats-bar">
                    <div class="stat-item">
                        <span>üìä Tokens:</span>
                        <span class="stat-value mono" id="tokenCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>üè¶ Positions:</span>
                        <span class="stat-value mono" id="positionCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>‚õìÔ∏è Chains:</span>
                        <span class="stat-value mono" id="chainCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Portfolio Distribution</h3>
                        <div class="chart-toggle">
                            <button class="chart-toggle-btn active" onclick="switchPortfolioChart('token')">By Token</button>
                            <button class="chart-toggle-btn" onclick="switchPortfolioChart('chain')">By Chain</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">DeFi Distribution</h3>
                        <div class="chart-toggle">
                            <button class="chart-toggle-btn active" onclick="switchDefiChart('protocol')">By Protocol</button>
                            <button class="chart-toggle-btn" onclick="switchDefiChart('chain')">By Chain</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="defiChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card" id="walletSection">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="cursor: pointer;" onclick="scrollToSection('walletSection')">üíé Wallet Tokens</h2>
                    <div id="walletLoadingStatus" class="chain-loading" style="display: none;">
                        <div class="chain-loading-spinner"></div>
                        <span id="walletLoadingText">Loading...</span>
                    </div>
                </div>
                <div class="chain-filters" id="walletFilters">
                    <div class="chain-filter active" data-chain="all">All</div>
                    <div class="chain-filter" data-chain="Ethereum">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png" alt="ETH"> ETH
                    </div>
                    <div class="chain-filter" data-chain="Arbitrum">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/arbitrum/info/logo.png" alt="ARB"> ARB
                    </div>
                    <div class="chain-filter" data-chain="Polygon">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/polygon/info/logo.png" alt="POL"> POL
                    </div>
                    <div class="chain-filter" data-chain="Avalanche">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/info/logo.png" alt="AVAX"> AVAX
                    </div>
                    <div class="chain-filter" data-chain="BNB Chain">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png" alt="BNB"> BNB
                    </div>
                </div>
                <div id="walletBalances"></div>
            </div>

            <div class="card" id="defiSection">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="cursor: pointer;" onclick="scrollToSection('defiSection')">üè¶ DeFi Positions</h2>
                    <div id="defiLoadingStatus" class="chain-loading" style="display: none;">
                        <div class="chain-loading-spinner"></div>
                        <span id="defiLoadingText">Loading...</span>
                    </div>
                </div>
                <div class="chain-filters" id="defiFilters">
                    <div class="chain-filter active" data-chain="all">All</div>
                    <div class="chain-filter" data-chain="Ethereum">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png" alt="ETH"> ETH
                    </div>
                    <div class="chain-filter" data-chain="Arbitrum">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/arbitrum/info/logo.png" alt="ARB"> ARB
                    </div>
                    <div class="chain-filter" data-chain="Polygon">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/polygon/info/logo.png" alt="POL"> POL
                    </div>
                    <div class="chain-filter" data-chain="Avalanche">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/info/logo.png" alt="AVAX"> AVAX
                    </div>
                    <div class="chain-filter" data-chain="BNB Chain">
                        <img src="https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png" alt="BNB"> BNB
                    </div>
                </div>
                <div id="defiPositions"></div>
            </div>
        </div>
    </div>

    <script>
        // Theme Management
        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            const newTheme = toggle.checked ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Refresh charts to update colors
            if (portfolioChart && allWalletBalances.length > 0) {
                createPortfolioChart(portfolioChartMode);
            }
            if (defiChart && allDefiPositions.length > 0) {
                createDefiChart(defiChartMode);
            }
        }

        // Loading message cycling
        const loadingMessages = [
            "üîç Resolving address...",
            "‚ö° Checking balances...",
            "üåê Scanning across chains...",
            "üè¶ Checking DeFi positions...",
            "üí∞ Calculating USD rates...",
            "üîé Hang tight, found another position...",
            "üìä Almost there...",
            "üé® Building the page...",
            "‚è≥ Please stand by...",
            "üöÄ Finalizing results..."
        ];

        function startLoadingMessages() {
            loadingMessageIndex = 0;
            const loadingMessageEl = document.getElementById('loadingMessage');
            loadingMessageEl.textContent = loadingMessages[0];
            
            loadingMessageInterval = setInterval(() => {
                loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
                loadingMessageEl.textContent = loadingMessages[loadingMessageIndex];
            }, 4500); // Change message every 4.5 seconds
        }

        function stopLoadingMessages() {
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }
        }

        // Scroll functions
        function scrollToWallet() {
            const walletSection = document.getElementById('walletSection');
            if (walletSection) {
                walletSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function scrollToDefi() {
            const defiSection = document.getElementById('defiSection');
            if (defiSection) {
                defiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function scrollToTopSmooth() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show/hide scroll to top button
        window.addEventListener('scroll', function() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        });

        // Scroll functions
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show/hide scroll to top button
        window.addEventListener('scroll', function() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        });

        // URL routing functions
        function getAddressFromURL() {
            const path = window.location.pathname;
            const match = path.match(/\/address\/(.+)/);
            return match ? match[1] : null;
        }

        function updateURL(address) {
            const newURL = `/address/${address}`;
            window.history.pushState({ address: address }, '', newURL);
        }

        function checkAddressFromURL() {
            const address = getAddressFromURL();
            if (address) {
                console.log('Address found in URL:', address);
                document.getElementById('addressInput').value = address;
                // Small delay to ensure DOM is ready
                setTimeout(() => checkAddress(), 100);
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.address) {
                document.getElementById('addressInput').value = event.state.address;
                checkAddress();
            }
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').checked = savedTheme === 'light';

        // Check for URL parameter on page load
        window.addEventListener('DOMContentLoaded', checkAddressFromURL);

        // Local Storage Manager
        const CACHE_KEY = 'portfolio_cache';
        const SAVED_ADDRESSES_KEY = 'saved_addresses';
        const ICON_CACHE_KEY = 'token_icon_cache';
        const LAST_REFRESH_KEY = 'last_refresh_times';
        
        // Cache durations (in milliseconds)
        const CACHE_DURATION = 24 * 60 * 60 * 1000;           // 24 hours for portfolio data
        const LOCAL_STORAGE_DURATION = 30 * 24 * 60 * 60 * 1000;  // 30 days for local storage
        const ICON_CACHE_DURATION = 30 * 24 * 60 * 60 * 1000;     // 30 days for token icons
        const REFRESH_COOLDOWN = 5 * 60 * 1000;               // 5 minutes between refreshes
        
        // Track last refresh times per address
        function getLastRefreshTime(address) {
            try {
                const refreshTimes = JSON.parse(localStorage.getItem(LAST_REFRESH_KEY) || '{}');
                return refreshTimes[address.toLowerCase()] || 0;
            } catch (e) {
                return 0;
            }
        }
        
        function setLastRefreshTime(address) {
            try {
                const refreshTimes = JSON.parse(localStorage.getItem(LAST_REFRESH_KEY) || '{}');
                refreshTimes[address.toLowerCase()] = Date.now();
                localStorage.setItem(LAST_REFRESH_KEY, JSON.stringify(refreshTimes));
            } catch (e) {
                console.error('Error setting refresh time:', e);
            }
        }
        
        function canRefresh(address) {
            const lastRefresh = getLastRefreshTime(address);
            const timeSinceRefresh = Date.now() - lastRefresh;
            return timeSinceRefresh >= REFRESH_COOLDOWN;
        }
        
        function getRefreshCooldownRemaining(address) {
            const lastRefresh = getLastRefreshTime(address);
            const timeSinceRefresh = Date.now() - lastRefresh;
            const remaining = REFRESH_COOLDOWN - timeSinceRefresh;
            return Math.max(0, Math.ceil(remaining / 1000)); // seconds
        }

        let allWalletBalances = [];
        let allDefiPositions = [];
        let activeWalletFilter = 'all';
        let activeDefiFilter = 'all';
        let currentAddress = '';
        let loadingMessageInterval = null;
        let loadingMessageIndex = 0;

        // Map token symbols to CoinGecko IDs for icons
        const tokenToCoinGecko = {
            'ETH': 'ethereum', 'WETH': 'ethereum',
            'USDC': 'usd-coin', 'USDT': 'tether', 'DAI': 'dai',
            'WBTC': 'wrapped-bitcoin', 'BTCB': 'bitcoin', 'tBTC': 'tbtc',
            'AAVE': 'aave', 'UNI': 'uniswap', 'LINK': 'chainlink',
            'ARB': 'arbitrum', 'MATIC': 'matic-network', 'WMATIC': 'matic-network',
            'AVAX': 'avalanche-2', 'WAVAX': 'avalanche-2',
            'BNB': 'binancecoin', 'WBNB': 'binancecoin',
            'CAKE': 'pancakeswap-token', 'stETH': 'lido-staked-ether', 'wstETH': 'wrapped-steth',
            'rETH': 'rocket-pool-eth', 'GMX': 'gmx', 'GLP': 'gmx',
            'JOE': 'joe', 'CRV': 'curve-dao-token',
            'CVX': 'convex-finance', 'SUSHI': 'sushi', 'BAL': 'balancer',
            'FRAX': 'frax', 'FXS': 'frax-share',
            'VERSE': 'verse', 'stVERSE': 'verse'
        };

        const chainInfo = {
            'Ethereum': { coingecko: 'ethereum', color: '#627EEA' },
            'Arbitrum One': { coingecko: 'arbitrum', color: '#28A0F0' },
            'Polygon': { coingecko: 'matic-network', color: '#8247E5' },
            'Avalanche': { coingecko: 'avalanche-2', color: '#E84142' },
            'BNB Chain': { coingecko: 'binancecoin', color: '#F3BA2F' }
        };

        const chartColors = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe',
            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#c471f5', '#fa71cd'
        ];

        let portfolioChart = null;
        let defiChart = null;
        let portfolioChartMode = 'token';
        let defiChartMode = 'protocol';
        let lastRefreshClick = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedAddresses();
        });

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function formatTokenAmount(amount) {
            const num = parseFloat(amount);
            if (num >= 1000) {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            }
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 6
            }).format(num);
        }

        function normalizeTokenName(symbol) {
            // Normalize token display names
            const nameMap = {
                'fxVERSE': 'VERSE',
                'vstBTC': 'vstBTC',
                'vTeam': 'vTeam',
                'stVERSE': 'stVERSE'
            };
            return nameMap[symbol] || symbol;
        }

        function getTokenIcon(symbol) {
            // Multiple fallback sources for token icons
            const tokenIconMap = {
                'ETH': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png',
                'WETH': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png',
                'USDC': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png',
                'USDT': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xdAC17F958D2ee523a2206206994597C13D831ec7/logo.png',
                'DAI': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x6B175474E89094C44Da98b954EedeAC495271d0F/logo.png',
                'WBTC': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599/logo.png',
                'AAVE': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9/logo.png',
                'UNI': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984/logo.png',
                'LINK': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x514910771AF9Ca656af840dff83E8264EcF986CA/logo.png',
                'MATIC': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/polygon/info/logo.png',
                'WMATIC': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/polygon/info/logo.png',
                'BNB': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png',
                'WBNB': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png',
                'AVAX': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/info/logo.png',
                'WAVAX': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/info/logo.png',
                'VERSE': 'https://verse.bitcoin.com/icons/verse-icon-512x512.png',
                'fxVERSE': 'https://verse.bitcoin.com/icons/verse-icon-512x512.png',
                'stVERSE': 'https://verse.bitcoin.com/icons/verse-icon-512x512.png',
                'vTeam': 'https://verse.bitcoin.com/icons/verse-icon-512x512.png',
                'vstBTC': 'https://verse.bitcoin.com/icons/verse-icon-512x512.png'
            };
            
            const coingeckoId = tokenToCoinGecko[symbol];
            const iconUrl = tokenIconMap[symbol];
            
            // Build fallback chain: Trust Wallet ‚Üí CoinGecko ‚Üí Cryptologos ‚Üí Text
            const fallbacks = [];
            
            if (iconUrl) {
                fallbacks.push(iconUrl);
            }
            
            if (coingeckoId) {
                fallbacks.push(`https://assets.coingecko.com/coins/images/small/${coingeckoId}.png`);
            }
            
            // Cryptologos as additional fallback
            fallbacks.push(`https://cryptologos.cc/logos/${symbol.toLowerCase()}-${symbol.toLowerCase()}-logo.png`);
            
            if (fallbacks.length > 0) {
                let onerrorChain = '';
                for (let i = 1; i < fallbacks.length; i++) {
                    onerrorChain = `if(this.src !== '${fallbacks[i]}') { this.src='${fallbacks[i]}'; } else { ${onerrorChain}`;
                }
                onerrorChain += `this.style.display='none'; this.parentElement.innerHTML='<span class=\\'token-fallback\\'>${symbol.substring(0, 3).toUpperCase()}</span>';`;
                onerrorChain += ' }'.repeat(fallbacks.length - 1);
                
                return `<img src="${fallbacks[0]}" alt="${symbol}" onerror="${onerrorChain}">`;
            }
            
            // Final fallback to text
            return `<span class="token-fallback">${symbol.substring(0, 3).toUpperCase()}</span>`;
        }

        function getChainIcon(chainName, iconOnly = false) {
            const chainIcons = {
                'Ethereum': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/info/logo.png',
                'Arbitrum': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/arbitrum/info/logo.png',
                'Arbitrum One': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/arbitrum/info/logo.png',
                'Polygon': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/polygon/info/logo.png',
                'Avalanche': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/avalanchec/info/logo.png',
                'BNB Chain': 'https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/smartchain/info/logo.png'
            };
            
            const iconUrl = chainIcons[chainName];
            if (!iconUrl) return iconOnly ? '' : chainName;
            
            const icon = `<img src="${iconUrl}" alt="${chainName}" style="width: 16px; height: 16px; border-radius: 50%;" onerror="this.style.display='none'">`;
            
            if (iconOnly) {
                return icon;
            }
            
            return `<span class="chain-icon" style="display: flex; align-items: center; gap: 6px;">${icon} ${chainName}</span>`;
        }

        function handleRefreshClick() {
            const now = Date.now();
            const timeSinceLastClick = now - lastRefreshClick;
            
            if (timeSinceLastClick < 500) {
                // Double click detected - force refresh with cache clear
                console.log('Double-tap detected: Force refresh with cache clear');
                forceRefresh();
            } else {
                // Single click - refresh with existing cache strategy
                console.log('Single tap: Normal refresh');
                if (currentAddress) {
                    checkAddress();
                }
            }
            
            lastRefreshClick = now;
        }

        function clearAllCaches() {
            // Clear portfolio cache
            localStorage.removeItem(CACHE_KEY);
            // Clear icon cache
            localStorage.removeItem(ICON_CACHE_KEY);
            console.log('All caches cleared');
        }

        function getCachedData(address) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                const cached = cache[address.toLowerCase()];
                
                if (cached) {
                    const age = Date.now() - cached.timestamp;
                    
                    // Return data if within 30 days (local storage duration)
                    // Even if older than 24h, we show it with "stale" indicator
                    if (age < LOCAL_STORAGE_DURATION) {
                        return {
                            ...cached.data,
                            _cacheAge: age,
                            _isStale: age > CACHE_DURATION
                        };
                    }
                }
            } catch (e) {
                console.error('Error reading cache:', e);
            }
            return null;
        }

        function getCachedTimestamp(address) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                const cached = cache[address.toLowerCase()];
                return cached ? cached.timestamp : null;
            } catch (e) {
                return null;
            }
        }

        function setCachedData(address, data) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                cache[address.toLowerCase()] = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) {
                console.error('Error writing cache:', e);
            }
        }

        function saveAddress(address) {
            try {
                let saved = JSON.parse(localStorage.getItem(SAVED_ADDRESSES_KEY) || '[]');
                const addr = address.toLowerCase();
                saved = saved.filter(a => a !== addr);
                saved.unshift(addr);
                saved = saved.slice(0, 5);
                localStorage.setItem(SAVED_ADDRESSES_KEY, JSON.stringify(saved));
                loadSavedAddresses();
            } catch (e) {
                console.error('Error saving address:', e);
            }
        }

        function loadSavedAddresses() {
            try {
                const saved = JSON.parse(localStorage.getItem(SAVED_ADDRESSES_KEY) || '[]');
                const container = document.getElementById('savedAddresses');
                if (saved.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-tertiary); font-size: 0.9em;">No saved addresses yet</div>';
                    return;
                }
                container.innerHTML = saved.map(addr => `
                    <div class="saved-address" onclick="loadAddress('${addr}')">
                        <span>${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}</span>
                        <span class="remove" onclick="event.stopPropagation(); removeAddress('${addr}')">√ó</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading saved addresses:', e);
            }
        }

        function removeAddress(address) {
            try {
                let saved = JSON.parse(localStorage.getItem(SAVED_ADDRESSES_KEY) || '[]');
                saved = saved.filter(a => a !== address.toLowerCase());
                localStorage.setItem(SAVED_ADDRESSES_KEY, JSON.stringify(saved));
                loadSavedAddresses();
            } catch (e) {
                console.error('Error removing address:', e);
            }
        }

        function loadAddress(address) {
            document.getElementById('addressInput').value = address;
            checkAddress();
        }

        function forceRefresh() {
            if (!currentAddress) return;
            
            // Check if refresh is allowed (5 minute cooldown)
            if (!canRefresh(currentAddress)) {
                const remaining = getRefreshCooldownRemaining(currentAddress);
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const timeText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                
                showToast(`‚è≥ Please wait ${timeText} before refreshing again`);
                console.log(`Refresh cooldown: ${remaining}s remaining`);
                return;
            }
            
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('spinning');
            
            // Clear only the current address cache (not icon cache)
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                delete cache[currentAddress.toLowerCase()];
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
                console.log(`Cache cleared for ${currentAddress}`);
            } catch (e) {
                console.error('Error clearing cache:', e);
            }
            
            // Set refresh time
            setLastRefreshTime(currentAddress);
            
            // Fetch fresh data
            checkAddress(true).finally(() => {
                setTimeout(() => {
                    refreshIcon.classList.remove('spinning');
                }, 500);
            });
        }

        // Production-ready cache management
        function getCacheStats() {
            const portfolioCache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
            const iconCache = JSON.parse(localStorage.getItem(ICON_CACHE_KEY) || '{}');
            
            return {
                portfolioEntries: Object.keys(portfolioCache).length,
                iconEntries: Object.keys(iconCache).length,
                portfolioSize: new Blob([JSON.stringify(portfolioCache)]).size,
                iconSize: new Blob([JSON.stringify(iconCache)]).size
            };
        }

        function pruneOldCaches() {
            // Remove expired entries from caches
            const now = Date.now();
            
            // Prune portfolio cache (30 days)
            try {
                const portfolioCache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                let pruned = 0;
                Object.keys(portfolioCache).forEach(key => {
                    if (now - portfolioCache[key].timestamp > LOCAL_STORAGE_DURATION) {
                        delete portfolioCache[key];
                        pruned++;
                    }
                });
                if (pruned > 0) {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(portfolioCache));
                    console.log(`üßπ Pruned ${pruned} expired portfolio cache entries (>30 days)`);
                }
            } catch (e) {
                console.error('Error pruning portfolio cache:', e);
            }
            
            // Prune icon cache (30 days)
            try {
                const iconCache = JSON.parse(localStorage.getItem(ICON_CACHE_KEY) || '{}');
                let pruned = 0;
                Object.keys(iconCache).forEach(key => {
                    if (now - iconCache[key].timestamp > ICON_CACHE_DURATION) {
                        delete iconCache[key];
                        pruned++;
                    }
                });
                if (pruned > 0) {
                    localStorage.setItem(ICON_CACHE_KEY, JSON.stringify(iconCache));
                    console.log(`üßπ Pruned ${pruned} expired icon cache entries (>30 days)`);
                }
            } catch (e) {
                console.error('Error pruning icon cache:', e);
            }
            
            // Prune old refresh times (30 days)
            try {
                const refreshTimes = JSON.parse(localStorage.getItem(LAST_REFRESH_KEY) || '{}');
                let pruned = 0;
                Object.keys(refreshTimes).forEach(key => {
                    if (now - refreshTimes[key] > LOCAL_STORAGE_DURATION) {
                        delete refreshTimes[key];
                        pruned++;
                    }
                });
                if (pruned > 0) {
                    localStorage.setItem(LAST_REFRESH_KEY, JSON.stringify(refreshTimes));
                    console.log(`üßπ Pruned ${pruned} old refresh time entries (>30 days)`);
                }
            } catch (e) {
                console.error('Error pruning refresh times:', e);
            }
        }

        // Run cache pruning on page load
        document.addEventListener('DOMContentLoaded', () => {
            pruneOldCaches();
            console.log('Cache stats:', getCacheStats());
        });

        async function resolveENS(input) {
            if (input.startsWith('0x') && input.length === 42) {
                return input;
            }

            try {
                const response = await fetch(`/api/resolve-ens/${encodeURIComponent(input)}`);
                const data = await response.json();
                if (response.ok && data.address) {
                    return data.address;
                } else {
                    throw new Error(data.error || 'Failed to resolve ENS');
                }
            } catch (err) {
                throw new Error(`ENS resolution failed: ${err.message}`);
            }
        }

        async function checkAddress(forceRefresh = false) {
            const input = document.getElementById('addressInput').value.trim();
            if (!input) {
                document.getElementById('errorMessage').textContent = 'Please enter an address or ENS name';
                document.getElementById('errorMessage').classList.add('active');
                return;
            }

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const error = document.getElementById('errorMessage');
            const checkButton = document.getElementById('checkButton');
            const refreshIcon = document.getElementById('refreshIcon');

            error.classList.remove('active');
            results.classList.remove('active');
            loading.classList.add('active');
            checkButton.disabled = true;
            
            // Start cycling loading messages
            startLoadingMessages();
            
            // Show loading indicators
            document.getElementById('walletLoadingStatus').style.display = 'flex';
            document.getElementById('defiLoadingStatus').style.display = 'flex';
            document.getElementById('walletLoadingText').textContent = 'Fetching wallet balances...';
            document.getElementById('defiLoadingText').textContent = 'Fetching DeFi positions...';

            try {
                const address = await resolveENS(input);
                currentAddress = address;
                
                // Update URL with the resolved address
                updateURL(address);

                if (!forceRefresh) {
                    const cached = getCachedData(address);
                    if (cached) {
                        console.log('Using cached data');
                        allWalletBalances = cached.wallet_balances;
                        allDefiPositions = cached.defi_positions;
                        displayResults(cached, true);
                        results.classList.add('active');
                        loading.classList.remove('active');
                        checkButton.disabled = false;
                        refreshIcon.style.display = 'flex';
                        document.getElementById('controlsDivider').style.display = 'block';
                        saveAddress(address);
                        return;
                    }
                }

                const response = await fetch(`/api/check/${address}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch data');
                }

                allWalletBalances = data.wallet_balances;
                allDefiPositions = data.defi_positions;
                
                setCachedData(address, data);
                
                displayResults(data, false);
                results.classList.add('active');
                refreshIcon.style.display = 'flex';
                document.getElementById('controlsDivider').style.display = 'block';
                saveAddress(address);
            } catch (err) {
                error.textContent = `Error: ${err.message}`;
                error.classList.add('active');
            } finally {
                loading.classList.remove('active');
                checkButton.disabled = false;
                
                // Stop cycling loading messages
                stopLoadingMessages();
                
                // Hide loading indicators
                document.getElementById('walletLoadingStatus').style.display = 'none';
                document.getElementById('defiLoadingStatus').style.display = 'none';
            }
        }

        function displayResults(data, fromCache) {
            const cacheInfo = document.getElementById('cacheInfo');
            
            // Check if data came from server cache or client cache
            const isServerCached = data._server_cached === true;
            const isClientCached = fromCache && !isServerCached;
            
            if (isServerCached || isClientCached) {
                // Get timestamp from server response or client cache
                let timestamp;
                if (isServerCached && data.timestamp) {
                    // Server cached data - use server's timestamp
                    timestamp = new Date(data.timestamp).getTime();
                } else {
                    // Client cached data - use client's cached timestamp
                    timestamp = getCachedTimestamp(currentAddress);
                }
                
                const age = Date.now() - timestamp;
                const ageSeconds = Math.floor(age / 1000);
                const ageMinutes = Math.floor(ageSeconds / 60);
                const ageHours = Math.floor(ageMinutes / 60);
                const ageDays = Math.floor(ageHours / 24);
                
                // Format age text
                let ageText;
                if (ageMinutes < 1) {
                    ageText = 'just now';
                } else if (ageHours < 1) {
                    ageText = `${ageMinutes}m ago`;
                } else if (ageDays < 1) {
                    ageText = `${ageHours}h ago`;
                } else {
                    ageText = `${ageDays}d ago`;
                }
                
                // Determine freshness
                const isStale = age > CACHE_DURATION;
                const canRefreshNow = canRefresh(currentAddress);
                
                let hint = '';
                if (isStale) {
                    if (canRefreshNow) {
                        hint = ' ‚Ä¢ Click refresh for latest';
                    } else {
                        const cooldownSecs = getRefreshCooldownRemaining(currentAddress);
                        hint = ` ‚Ä¢ Refresh in ${cooldownSecs}s`;
                    }
                } else {
                    const remainingHours = Math.floor((CACHE_DURATION - age) / 1000 / 60 / 60);
                    if (remainingHours > 0) {
                        hint = ` ‚Ä¢ Fresh for ${remainingHours}h`;
                    }
                }
                
                const emoji = isStale ? '‚ö†Ô∏è' : 'üì¶';
                const cacheSource = isServerCached ? 'Server cached' : 'Cached';
                cacheInfo.innerHTML = `${emoji} ${cacheSource} ${ageText}${hint}`;
                cacheInfo.classList.add('cached');
                if (isStale) cacheInfo.classList.add('stale');
                cacheInfo.title = `Last updated: ${new Date(timestamp).toLocaleString()}`;
            } else {
                cacheInfo.innerHTML = `‚ú® Live data`;
                cacheInfo.classList.remove('cached', 'stale');
                cacheInfo.title = 'Freshly fetched from blockchain';
            }

            document.getElementById('totalValue').textContent = `$${formatNumber(data.total_value_usd)}`;
            document.getElementById('walletValue').textContent = `$${formatNumber(data.wallet_value_usd)}`;
            document.getElementById('defiValue').textContent = `$${formatNumber(data.defi_value_usd)}`;

            // Stats
            const uniqueChains = new Set([...data.wallet_balances.map(b => b.chain), ...data.defi_positions.map(p => p.chain)]);
            document.getElementById('tokenCount').textContent = data.wallet_balances.length;
            document.getElementById('positionCount').textContent = data.defi_positions.length;
            document.getElementById('chainCount').textContent = uniqueChains.size;

            displayWalletBalances();
            displayDefiPositions();
            setupFilters();
            
            // Create charts
            if (allWalletBalances.length > 0) {
                createPortfolioChart(portfolioChartMode);
            }
            if (allDefiPositions.length > 0) {
                createDefiChart(defiChartMode);
            }
        }

        function getCachedTimestamp(address) {
            try {
                const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                return cache[address.toLowerCase()]?.timestamp || Date.now();
            } catch {
                return Date.now();
            }
        }

        function displayWalletBalances() {
            const container = document.getElementById('walletBalances');
            const filtered = activeWalletFilter === 'all' 
                ? allWalletBalances 
                : allWalletBalances.filter(b => b.chain === activeWalletFilter);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üíé</div><p>No wallet tokens found</p></div>';
                return;
            }

            container.innerHTML = filtered.map(balance => {
                const displayName = normalizeTokenName(balance.symbol);
                return `
                <div class="wide-card">
                    <div class="token-icon-wrapper">
                        <div class="token-icon">
                            ${getTokenIcon(balance.symbol)}
                        </div>
                        <div class="token-info">
                            <div class="token-symbol">${displayName}</div>
                            <div class="token-chain">${getChainIcon(balance.chain)}</div>
                        </div>
                    </div>
                    <div class="token-amount">
                        <div class="amount-value mono">${formatTokenAmount(balance.balance)}</div>
                        <div class="amount-label">${displayName}</div>
                    </div>
                    <div class="usd-value">
                        <div class="usd-amount mono">$${formatNumber(balance.balance_usd)}</div>
                    </div>
                </div>
            `}).join('');
        }

        function displayDefiPositions() {
            const container = document.getElementById('defiPositions');
            const filtered = activeDefiFilter === 'all' 
                ? allDefiPositions 
                : allDefiPositions.filter(p => p.chain === activeDefiFilter);

            console.log('=== displayDefiPositions called ===');
            console.log('Total positions:', allDefiPositions.length);
            console.log('Filtered positions:', filtered.length);
            console.log('Active filter:', activeDefiFilter);
            console.log('All positions:', allDefiPositions);

            if (filtered.length === 0) {
                console.log('‚ö†Ô∏è No filtered positions to display');
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè¶</div><p>No DeFi positions found</p></div>';
                return;
            }

            // Group Aave and Verse positions by chain
            const aavePositions = {};
            const versePositions = {};
            const otherPositions = [];
            
            filtered.forEach(position => {
                console.log('Processing position:', position.protocol, position.token, position.is_debt);
                if (position.protocol === 'Aave V3') {
                    const key = position.chain;
                    if (!aavePositions[key]) {
                        aavePositions[key] = { supply: [], borrow: [] };
                    }
                    if (position.is_debt) {
                        console.log('  -> Adding to borrow');
                        aavePositions[key].borrow.push(position);
                    } else {
                        console.log('  -> Adding to supply');
                        aavePositions[key].supply.push(position);
                    }
                } else if (position.protocol === 'Verse Ecosystem') {
                    const key = position.chain;
                    if (!versePositions[key]) {
                        versePositions[key] = [];
                    }
                    console.log('  -> Adding to Verse Ecosystem positions');
                    versePositions[key].push(position);
                } else {
                    console.log('  -> Adding to other positions');
                    otherPositions.push(position);
                }
            });

            console.log('Aave positions grouped:', aavePositions);
            console.log('Other positions:', otherPositions.length);

            let html = '';

            // Display grouped Aave positions first
            Object.keys(aavePositions).forEach(chain => {
                const positions = aavePositions[chain];
                const supplyTotal = positions.supply.reduce((sum, p) => sum + parseFloat(p.value_usd || 0), 0);
                const borrowTotal = Math.abs(positions.borrow.reduce((sum, p) => sum + parseFloat(p.value_usd || 0), 0));
                const netValue = supplyTotal - borrowTotal;
                const healthFactor = borrowTotal > 0 ? (supplyTotal * 0.75) / borrowTotal : 999;
                
                let healthBadge = '';
                if (borrowTotal > 0) {
                    if (healthFactor < 1.1) {
                        healthBadge = `<span class="health-badge health-critical">‚ö†Ô∏è Health: ${healthFactor.toFixed(2)}</span>`;
                    } else if (healthFactor < 1.5) {
                        healthBadge = `<span class="health-badge health-warning">‚ö†Ô∏è Health: ${healthFactor.toFixed(2)}</span>`;
                    } else {
                        healthBadge = `<span class="health-badge health-good">‚úÖ Health: ${healthFactor.toFixed(2)}</span>`;
                    }
                }

                html += `
                <div class="wide-card defi-card aave-group">
                    <div class="token-icon-wrapper">
                        <div class="token-icon">
                            ${getTokenIcon('AAVE')}
                        </div>
                        <div class="token-info">
                            <div class="token-symbol">
                                Aave V3
                                <span class="protocol-badge">Lending</span>
                                ${healthBadge}
                            </div>
                            <div class="position-type">${getChainIcon(chain)}</div>
                        </div>
                    </div>
                    <div class="token-amount">
                        <div class="aave-summary">
                            <div class="aave-line">üü¢ Supply: $${formatNumber(supplyTotal)}</div>
                            ${borrowTotal > 0 ? `<div class="aave-line">üî¥ Borrow: $${formatNumber(borrowTotal)}</div>` : ''}
                        </div>
                    </div>
                    <div class="usd-value">
                        <div class="usd-amount mono ${netValue < 0 ? 'negative' : ''}">$${formatNumber(Math.abs(netValue))}</div>
                        <div class="amount-label">Net Position</div>
                    </div>
                </div>`;

                // Show individual supply positions
                positions.supply.forEach(position => {
                    const valueUsd = parseFloat(position.value_usd) || 0;
                    html += `
                    <div class="wide-card defi-card aave-detail">
                        <div class="token-icon-wrapper">
                            <div class="token-icon">
                                ${getTokenIcon(position.token.split('/')[0])}
                            </div>
                            <div class="token-info">
                                <div class="token-symbol">
                                    ${position.token}
                                    <span class="protocol-badge supply-badge">Supply</span>
                                </div>
                                <div class="position-type">${getChainIcon(position.chain)}</div>
                            </div>
                        </div>
                        <div class="token-amount">
                            <div class="amount-value mono">${formatTokenAmount(position.amount)}</div>
                            <div class="amount-label">${position.token}</div>
                        </div>
                        <div class="usd-value">
                            <div class="usd-amount mono">$${formatNumber(valueUsd)}</div>
                        </div>
                    </div>`;
                });

                // Show individual borrow positions
                positions.borrow.forEach(position => {
                    const valueUsd = Math.abs(parseFloat(position.value_usd) || 0);
                    const amount = Math.abs(parseFloat(position.amount) || 0);
                    html += `
                    <div class="wide-card defi-card aave-detail">
                        <div class="token-icon-wrapper">
                            <div class="token-icon">
                                ${getTokenIcon(position.token.split('/')[0])}
                            </div>
                            <div class="token-info">
                                <div class="token-symbol">
                                    ${position.token}
                                    <span class="protocol-badge borrow-badge">Borrow</span>
                                </div>
                                <div class="position-type">${getChainIcon(position.chain)}</div>
                            </div>
                        </div>
                        <div class="token-amount">
                            <div class="amount-value mono">-${formatTokenAmount(amount)}</div>
                            <div class="amount-label">${position.token}</div>
                        </div>
                        <div class="usd-value">
                            <div class="usd-amount mono negative">-$${formatNumber(valueUsd)}</div>
                        </div>
                    </div>`;
                });
            });

            // Display grouped Verse positions
            Object.keys(versePositions).forEach(chain => {
                const positions = versePositions[chain];
                const totalValue = positions.reduce((sum, p) => sum + parseFloat(p.value_usd || 0), 0);
                
                html += `
                <div class="wide-card defi-card aave-group" style="border-left-color: #00D4AA;">
                    <div class="token-icon-wrapper">
                        <div class="token-icon">
                            ${getTokenIcon('VERSE')}
                        </div>
                        <div class="token-info">
                            <div class="token-symbol">
                                Verse Ecosystem
                                <span class="protocol-badge" style="background: rgba(0, 212, 170, 0.2); color: #00D4AA;">Ecosystem</span>
                            </div>
                            <div class="position-type">${getChainIcon(chain)}</div>
                        </div>
                    </div>
                    <div class="token-amount">
                        <div class="aave-summary">
                            <div class="aave-line">üíé Total Staked</div>
                        </div>
                    </div>
                    <div class="usd-value">
                        <div class="usd-amount mono">$${formatNumber(totalValue)}</div>
                        <div class="amount-label">Total Value</div>
                    </div>
                </div>`;

                // Show individual Verse positions
                positions.forEach(position => {
                    const valueUsd = parseFloat(position.value_usd) || 0;
                    const badgeText = position.token === 'vTeam' ? 'Team Staking' : 'Staking';
                    html += `
                    <div class="wide-card defi-card aave-detail" style="border-left-color: #00D4AA;">
                        <div class="token-icon-wrapper">
                            <div class="token-icon">
                                ${getTokenIcon(position.token.split('/')[0])}
                            </div>
                            <div class="token-info">
                                <div class="token-symbol">
                                    ${position.token}
                                    <span class="protocol-badge supply-badge" style="background: rgba(0, 212, 170, 0.15); color: #00D4AA;">${badgeText}</span>
                                </div>
                                <div class="position-type">${getChainIcon(position.chain)}</div>
                            </div>
                        </div>
                        <div class="token-amount">
                            <div class="amount-value mono">${formatTokenAmount(position.amount)}</div>
                            <div class="amount-label">${position.token}</div>
                        </div>
                        <div class="usd-value">
                            <div class="usd-amount mono">$${formatNumber(valueUsd)}</div>
                        </div>
                    </div>`;
                });
            });

            // Display other positions
            otherPositions.forEach(position => {
                const valueUsd = parseFloat(position.value_usd) || 0;
                console.log(`Position: ${position.protocol} - ${position.token} = $${valueUsd}`);
                
                html += `
                <div class="wide-card defi-card">
                    <div class="token-icon-wrapper">
                        <div class="token-icon">
                            ${getTokenIcon(position.token.split('/')[0])}
                        </div>
                        <div class="token-info">
                            <div class="token-symbol">
                                ${position.token}
                                <span class="protocol-badge">${position.protocol}</span>
                            </div>
                            <div class="position-type">${position.position_type} ‚Ä¢ ${getChainIcon(position.chain)}</div>
                        </div>
                    </div>
                    <div class="token-amount">
                        <div class="amount-value mono">${formatTokenAmount(position.amount)}</div>
                        <div class="amount-label">${position.token}</div>
                    </div>
                    <div class="usd-value">
                        <div class="usd-amount mono">$${formatNumber(Math.abs(valueUsd))}</div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        function setupFilters() {
            document.querySelectorAll('#walletFilters .chain-filter').forEach(filter => {
                filter.addEventListener('click', () => {
                    document.querySelectorAll('#walletFilters .chain-filter').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    activeWalletFilter = filter.dataset.chain;
                    displayWalletBalances();
                });
            });

            document.querySelectorAll('#defiFilters .chain-filter').forEach(filter => {
                filter.addEventListener('click', () => {
                    document.querySelectorAll('#defiFilters .chain-filter').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    activeDefiFilter = filter.dataset.chain;
                    displayDefiPositions();
                });
            });
        }

        document.getElementById('addressInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAddress();
            }
        });

        // Chart Functions
        function getChartTextColor() {
            return getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
        }

        function getChartBackgroundColor() {
            return getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
        }

        function createPortfolioChart(mode) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            if (portfolioChart) {
                portfolioChart.destroy();
            }

            let data, labels;
            
            if (mode === 'token') {
                // Group by token
                const tokenData = {};
                allWalletBalances.forEach(balance => {
                    if (!tokenData[balance.symbol]) {
                        tokenData[balance.symbol] = 0;
                    }
                    tokenData[balance.symbol] += balance.balance_usd;
                });
                
                // Sort by value and take top 10
                const sorted = Object.entries(tokenData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                labels = sorted.map(([token]) => token);
                data = sorted.map(([, value]) => value);
            } else {
                // Group by chain
                const chainData = {};
                allWalletBalances.forEach(balance => {
                    if (!chainData[balance.chain]) {
                        chainData[balance.chain] = 0;
                    }
                    chainData[balance.chain] += balance.balance_usd;
                });
                
                labels = Object.keys(chainData);
                data = Object.values(chainData);
            }

            // Responsive legend position
            const isMobile = window.innerWidth < 769;
            
            portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors,
                        borderWidth: 2,
                        borderColor: getChartBackgroundColor()
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: isMobile ? 1.5 : 2,
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'right',
                            labels: {
                                color: getChartTextColor(),
                                padding: isMobile ? 6 : 15,
                                font: {
                                    size: isMobile ? 9 : 12,
                                    family: 'Inter'
                                },
                                boxWidth: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${formatNumber(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function createDefiChart(mode) {
            const ctx = document.getElementById('defiChart').getContext('2d');
            
            if (defiChart) {
                defiChart.destroy();
            }

            // Check if we have DeFi positions
            console.log('createDefiChart called with mode:', mode);
            console.log('allDefiPositions:', allDefiPositions);
            
            if (!allDefiPositions || allDefiPositions.length === 0) {
                console.log('‚ùå No DeFi positions to chart');
                return;
            }

            let data, labels;
            
            if (mode === 'protocol') {
                // Group by protocol - use absolute values for chart
                const protocolData = {};
                allDefiPositions.forEach(position => {
                    console.log('Processing DeFi position for chart:', {
                        protocol: position.protocol,
                        token: position.token,
                        value_usd: position.value_usd,
                        amount: position.amount,
                        is_debt: position.is_debt
                    });
                    
                    if (!protocolData[position.protocol]) {
                        protocolData[position.protocol] = 0;
                    }
                    // Use absolute value for chart display (debt shows as positive in pie chart)
                    const value = Math.abs(parseFloat(position.value_usd) || 0);
                    console.log(`  Adding ${value} to ${position.protocol}`);
                    protocolData[position.protocol] += value;
                });
                
                console.log('Protocol data aggregated:', protocolData);
                
                // Sort by value and filter out zero values
                const sorted = Object.entries(protocolData)
                    .filter(([, value]) => value > 0)
                    .sort((a, b) => b[1] - a[1]);
                
                console.log('Sorted protocol data:', sorted);
                
                if (sorted.length === 0) {
                    console.log('‚ùå No DeFi positions with value > 0');
                    return;
                }
                
                labels = sorted.map(([protocol]) => protocol);
                data = sorted.map(([, value]) => value);
                console.log('Chart labels:', labels);
                console.log('Chart data:', data);
            } else {
                // Group by chain - use absolute values for chart
                const chainData = {};
                allDefiPositions.forEach(position => {
                    if (!chainData[position.chain]) {
                        chainData[position.chain] = 0;
                    }
                    // Use absolute value for chart display
                    const value = Math.abs(parseFloat(position.value_usd) || 0);
                    chainData[position.chain] += value;
                });
                
                // Filter out zero values
                const filtered = Object.entries(chainData)
                    .filter(([, value]) => value > 0);
                
                if (filtered.length === 0) {
                    console.log('No DeFi positions with value > 0 by chain');
                    return;
                }
                
                labels = filtered.map(([chain]) => chain);
                data = filtered.map(([, value]) => value);
            }

            // Responsive legend position
            const isMobile = window.innerWidth < 769;
            
            defiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors,
                        borderWidth: 2,
                        borderColor: getChartBackgroundColor()
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: isMobile ? 1.5 : 2,
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'right',
                            labels: {
                                color: getChartTextColor(),
                                padding: isMobile ? 6 : 15,
                                font: {
                                    size: isMobile ? 9 : 12,
                                    family: 'Inter'
                                },
                                boxWidth: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${formatNumber(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function switchPortfolioChart(mode) {
            portfolioChartMode = mode;
            
            // Update button states
            document.querySelectorAll('#portfolioChart').forEach(canvas => {
                const card = canvas.closest('.chart-card');
                card.querySelectorAll('.chart-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                card.querySelector(`[onclick="switchPortfolioChart('${mode}')"]`).classList.add('active');
            });
            
            createPortfolioChart(mode);
        }

        function switchDefiChart(mode) {
            defiChartMode = mode;
            
            // Update button states
            document.querySelectorAll('#defiChart').forEach(canvas => {
                const card = canvas.closest('.chart-card');
                card.querySelectorAll('.chart-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                card.querySelector(`[onclick="switchDefiChart('${mode}')"]`).classList.add('active');
            });
            
            createDefiChart(mode);
        }

        // Toast notification system
        function showToast(title, message, duration = 5000) {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            if (duration > 0) {
                setTimeout(() => {
                    hideToast();
                }, duration);
            }
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('show');
        }

        // Monitor for rate limit errors
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).then(response => {
                if (response.status === 429) {
                    showToast(
                        '‚ö†Ô∏è Rate Limit',
                        'Too many requests. Some data may be incomplete. Please wait a moment and refresh.',
                        8000
                    );
                }
                return response;
            });
        };
    </script>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-icon">‚ö†Ô∏è</div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">Notification</div>
            <div class="toast-message" id="toastMessage">Message</div>
        </div>
        <button class="toast-close" onclick="hideToast()">√ó</button>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-links">
            <span>Powered by</span>
            <a href="https://wallet.bitcoin.com" target="_blank" rel="noopener">Bitcoin.com Wallet</a>
            <span>&</span>
            <a href="https://rindexer.xyz" target="_blank" rel="noopener">Rindexer</a>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scrollToTop" class="scroll-to-top" onclick="scrollToTopSmooth()" title="Scroll to top">
        ‚Üë
    </button>
</body>
</html>
